<html>
<head>
<!-- <link href="Schema.css" rel="stylesheet" type="text/css" /> -->
<link href="GoodJava.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	$("#loadGoodApp").click(function(){
	//$("#editorCanvas").append("Hello Two").css("color","red");
	var fileName = $("#txtFileName").get(0).value;
	//alert(fileName);
	$.ajax({
		type: "GET",
		url: fileName,
		cache: false,
		success: readXML/* function(xml){
			$("#editorCanvas").append(xml);
		}*/,
		error: function(httpReq, textStatus, errorThrown)
		{
			alert(textStatus);
			alert(errorThrown);
		}
	});
	//return false;
	});
});

function on_select_change()
{
//	alert($(this).text());
//	alert("hello world");
	state.loadState(ViewerUIState.getConstant("UPDATE_ACTIVE_TAG"),"#editorCanvas",this);
	state.updateDimensionsPanel("#editorCanvas");
	state.updateActualDocument("#editorCanvas");
};

function readXML(xml)
{
	state = new ViewerUIState(xml);
	state.loadState(ViewerUIState.getConstant("INIT_LOAD"),"#editorCanvas");
	state.updateDimensionsPanel("#editorCanvas");
	state.updateActualDocument("#editorCanvas");

	var currVar = null;
	//$("#editorCanvas").children("document").children("part").find("variable").each(function(){ currVar=this; return this;}).parents("let").each(function(){
	//    if ($(this).children("binding").children("name").text() == $(currVar).text())
    //	{
			//TODO: Need to able to propergate the correct "data" field into the variable area and subsitute that. 
      	//	var properData = $(this).children("binding").children("value").find("data").each(function(){alert($(this).text());
		//	}));
     		 //$(currVar).text($(this).children("binding").children("value").children("part").children("data").text());
    //	}
	//});
};

var Dimension = function(name, defaultTag){
	this.name = name;
	this._tags = new Array();
	this.defaultTag = defaultTag;
}

Dimension.prototype.addTag = function(tag){
	this._tags.push(tag);
};

Dimension.prototype.Tags = function(){
	return this._tags;
};

var ViewerUIState = (function(){

	var constants = {
		INIT_LOAD:"INIT_LOAD_STATE",
		UPDATE_ACTIVE_TAG:"UPDATE_ACTIVE_TAG_STATE"
	}

	this.getConstant=function(name){
		return constants[name];
	}

	var constructor = function(xml){
		this._dimensions = new Array();
		this._activeTags = new Array();

		if (xml != null)
			this._xml = xml;
		else 
			throw new Error('The retriving XML cannot be empty.');

		this.ActiveTags = function(){
			return this._activeTags;
		}

		this.Dimensions = function(){
			return this._dimensions;
		}
	
		this.addDimension = function(dim){
			this._dimensions.push(dim);
		}
	
		this.clearActiveTags = function(tags)
		{
			this._activeTags = new Array();
		}
	
		this.addActiveTag = function(tag){
			this._activeTags.push(tag);
		}

		this.updateActiveTags = function(tags){
			this._activeTags =tags;
		}

		this._updateActiveTags = function()
		{
		}

		this.loadState = function(stateFlow,canvas)
		{
			if (stateFlow == ViewerUIState.getConstant("INIT_LOAD")){
				state.clearActiveTags();
				$(this._xml).find("dimension").each(function(){
					var dim = new Dimension($(this).children("name").text(), $(this).children("default").text());
					$(this).find("tag").each(function(){
						dim.addTag($(this).text());
					});
					state.addActiveTag($(this).children("default").text());
					state.addDimension(dim);
				});
				$(canvas).append(this._xml);
			}
			else if (stateFlow == ViewerUIState.getConstant("UPDATE_ACTIVE_TAG"))
			{
				var selected=null;
				if (arguments.length != 3) throw new Error("Must have three parameter for the load state function to work properly");
				{
					selected = arguments[2];
				}
				var foundDim = null;
				$.each(this.Dimensions(), function(){
					if ($.inArray($(selected).text(),this.Tags()) != -1){
						foundDim = this;
						return false;
					}
				});
				if (foundDim == null) throw new Error("The selected tag does not belong to any dimension");
				var oldActiveTags = this.ActiveTags();
				this.clearActiveTags();
				this.addActiveTag($(selected).text());
				for (var i in oldActiveTags)
				{
					if (oldActiveTags[i] != $(selected).text() && $.inArray(oldActiveTags[i], foundDim.Tags()) == -1)
						this.addActiveTag(oldActiveTags[i]);
				}
				$(canvas).empty();
				$(canvas).append(this._xml);
			}		
		}
		this.updateDimensionsPanel = function(canvas)
		{
			$(canvas).children("document").children("dimensions").find("tag").each(function(){
				if ($.inArray($(this).text(),state.ActiveTags())==-1){
					if ($(this).hasClass("selected"))
						$(this).removeClass("selected");
					$(this).addClass('potential');
					$(this).click(on_select_change);
				}else{
					if($(this).hasClass("potential"))
						$(this).removeClass("potential");
					$(this).addClass("selected");
					$(this).unbind('click',on_select_change);
				}
			});
		}
		this.updateActualDocument = function(canvas)
		{
			$(canvas).children("document").children("part").find("let").each(function(){
				var letElem = this;
				var varName = $(letElem).children("binding").children("name").text();
				var varValue = $(letElem).children("binding").children("value");
				$("#editorCanvas").children("document").find("variable").each(function(){
					if (varName == $(this).text())
					{
						//alert("Look at Variable Content "+ $(this).text());
						
						$(this).empty().append(varValue.clone());
						//alert($(varValue).text());
						//$(this).append(varValue);
						//alert("Look at After Variable Content "+$(this).text());
					}
				});
			});

			$(canvas).children("document").children("part").find("let").each(function(){
				$(this).children("binding").hide();
			});

			$(canvas).children("document").children("part").find("choice").each(function(){
				$(this).children("alternatives").children("alternative").each(function(){
					if ($.inArray($(this).children("label").children("tag").text(),state.ActiveTags())==-1)
						$(this).hide();
					else
						$(this).show();
				});
			});
		}
	};
	
	constructor.getConstant = getConstant;

	return constructor;
})();


var state = null;

function loadState(stateFlow)
{
	//$(xml).children("dimensions").hide();
//	$(xml).("document > dimensions 
}

</script>
</head>
<body>
<input type="textbox" name="fileName" value="GoodJava.xml" id="txtFileName" /><a id="loadGoodApp" href="#">Link</a>
<div id="editorCanvas"></div>
</body>
</html>
